<Window x:Class="PZTools.Core.Windows.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:PZTools"
        xmlns:view="clr-namespace:PZTools.Core.Models.View"
        xmlns:models="clr-namespace:PZTools.Core.Models"
        xmlns:avalonedit="http://icsharpcode.net/sharpdevelop/avalonedit"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        mc:Ignorable="d"
        Title="PZ Tools"
        Height="565"
        Width="895"
        WindowState="Maximized"
        Loaded="Window_Loaded"
        MinWidth="700"
        MinHeight="420"
        Background="{DynamicResource Brush.BgApp}"
        Foreground="{DynamicResource Brush.TextPrimary}" Closing="Window_Closing" Icon="/Core/Assets/Icons/PZToolsIcon.png">
    <Window.Resources>

        <!-- Editor font size (can be overridden at runtime from AppSettings.EditorFontSize) -->
        <sys:Double x:Key="EditorFontSize">14</sys:Double>

        <!-- Converters -->
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>

        <!-- MenuItem (app-specific) -->
        <Style TargetType="MenuItem" x:Key="MenuItemWithSeparatorStyle">
            <Setter Property="Header" Value="{Binding Header}" />
            <Setter Property="FontFamily" Value="Segoe UI"/>
            <Setter Property="Command" Value="{Binding Command}" />
            <Setter Property="ItemsSource" Value="{Binding Children}" />
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsSeparator}" Value="True">
                    <Setter Property="Header" Value="{x:Null}" />
                    <Setter Property="FontFamily" Value="Segoe UI"/>
                    <Setter Property="Command" Value="{x:Null}" />
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="MenuItem">
                                <Separator />
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <!-- MainWindow-local TextBox default: keep consistent with theme -->
        <Style TargetType="TextBox">
            <Setter Property="Background" Value="{DynamicResource Brush.BgApp}"/>
            <Setter Property="Foreground" Value="{DynamicResource Brush.TextPrimary}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource Brush.BorderStrong}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="6"/>
            <Setter Property="FontSize" Value="{DynamicResource EditorFontSize}"/>
        </Style>

        <!-- MainWindow-local TreeView default -->
        <Style TargetType="TreeView" BasedOn="{StaticResource ModernTreeView}"/>
        <Style TargetType="TreeViewItem" BasedOn="{StaticResource ModernTreeViewItem}"/>

    </Window.Resources>

    <Grid Background="{DynamicResource Brush.BgApp}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- Menu -->
            <RowDefinition Height="*"/>
            <!-- Main content -->
            <RowDefinition Height="4"/>
            <!-- Splitter -->
            <RowDefinition x:Name="LayoutConsole" Height="160" MinHeight="120"/>
            <RowDefinition Height="35"/>
            <!-- Status bar -->
        </Grid.RowDefinitions>

        <!-- Menu -->
        <Menu Grid.Row="0" ItemsSource="{Binding Menus}" Height="24">
            <Menu.ItemContainerStyle>
                <!-- keep your binding + separator logic, but base it on the themed MenuItem -->
                <Style TargetType="MenuItem"
               BasedOn="{StaticResource ModernMenuItem}">
                    <Setter Property="Header" Value="{Binding Header}" />
                    <Setter Property="Command" Value="{Binding Command}" />
                    <Setter Property="ItemsSource" Value="{Binding Children}" />
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding IsSeparator}" Value="True">
                            <Setter Property="Header" Value="{x:Null}" />
                            <Setter Property="Command" Value="{x:Null}" />
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="MenuItem">
                                        <Separator Style="{DynamicResource ModernMenuSeparator}"/>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Menu.ItemContainerStyle>
        </Menu>


        <!-- Main layout -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition x:Name="LayoutExplorer" Width="250"/>
                <ColumnDefinition x:Name="LayoutEditor" Width="*"/>
                <ColumnDefinition x:Name="LayoutProperties" Width="320"/>
            </Grid.ColumnDefinitions>

            <!-- Project Explorer -->
            <Border Grid.Column="0"
                    Background="{DynamicResource Brush.BgSurface}"
                    BorderBrush="{DynamicResource Brush.Border}"
                    BorderThickness="0,0,1,0"
                    Padding="8">

                <!-- If you want to keep GroupBox, leave it; otherwise swap to a TextBlock header + content -->
                <GroupBox Header="Project Explorer"
                          Foreground="{DynamicResource Brush.TextPrimary}"
                          Padding="8"
                          Background="Transparent"
                          BorderBrush="{DynamicResource Brush.Border}"
                          BorderThickness="0">
                    <TreeView x:Name="ProjectTreeView"
                              AllowDrop="True"
                              PreviewMouseLeftButtonDown="ProjectTreeView_PreviewMouseLeftButtonDown"
                              MouseMove="ProjectTreeView_MouseMove"
                              DragOver="ProjectTreeView_DragOver"
                              Drop="ProjectTreeView_Drop"
                              PreviewMouseRightButtonDown="ProjectTreeView_PreviewMouseRightButtonDown"
                              ContextMenuOpening="ProjectTreeView_ContextMenuOpening">

                        <TreeView.Resources>

                            <HierarchicalDataTemplate DataType="{x:Type models:ProjectFileNode}"
                                                      ItemsSource="{Binding Children}">
                                <TextBlock Text="{Binding Name}"
                                           Foreground="{DynamicResource Brush.TextPrimary}"/>
                            </HierarchicalDataTemplate>

                            <HierarchicalDataTemplate DataType="{x:Type models:ModTarget}"
                                                      ItemsSource="{Binding FileTree.Children}">
                                <TextBlock Text="{Binding BuildName}"
                                           FontWeight="SemiBold"
                                           Foreground="{DynamicResource Brush.TextInfo}"/>
                            </HierarchicalDataTemplate>

                        </TreeView.Resources>
                    </TreeView>
                </GroupBox>
            </Border>

            <!-- Left splitter -->
            <GridSplitter Grid.Column="0"
                          Width="4"
                          Background="{DynamicResource Brush.Border}"
                          HorizontalAlignment="Right"/>

            <!-- Editor -->
            <Border Grid.Column="1"
                    Background="{DynamicResource Brush.BgApp}"
                    BorderBrush="{DynamicResource Brush.Border}"
                    BorderThickness="1,0,1,0">

                <!-- AvalonEdit: map to theme brushes -->
                <avalonedit:TextEditor x:Name="LuaEditor"
                                       ShowLineNumbers="True"
                                       FontFamily="Consolas"
                                       FontSize="{DynamicResource EditorFontSize}"
                                       IsReadOnly="True"
                                       Background="{DynamicResource Brush.BgApp}"
                                       Foreground="{DynamicResource Brush.TextPrimary}"/>
            </Border>

            <!-- Right splitter -->
            <GridSplitter Grid.Column="1"
                          Width="4"
                          Background="{DynamicResource Brush.Border}"
                          HorizontalAlignment="Right"/>

            <!-- Properties -->
            <Border Grid.Column="2"
                    Background="{DynamicResource Brush.BgSurface}"
                    BorderBrush="{DynamicResource Brush.Border}"
                    BorderThickness="1,0,0,0"
                    Padding="8">

                <GroupBox Header="File Properties"
                          Foreground="{DynamicResource Brush.TextPrimary}"
                          Background="Transparent"
                          BorderBrush="{DynamicResource Brush.Border}"
                          BorderThickness="0">
                    <StackPanel>
                        <TextBlock Text="Name:" Foreground="{DynamicResource Brush.TextMuted}"/>
                        <TextBox x:Name="txtPropName" IsReadOnly="True" Margin="0,0,0,8"/>

                        <TextBlock Text="Full Path:" Foreground="{DynamicResource Brush.TextMuted}"/>
                        <TextBox x:Name="txtPropPath" IsReadOnly="True" Margin="0,0,0,8"/>

                        <TextBlock Text="Size:" Foreground="{DynamicResource Brush.TextMuted}"/>
                        <TextBox x:Name="txtPropSize" IsReadOnly="True" Margin="0,0,0,8"/>

                        <TextBlock Text="Encoding:" Foreground="{DynamicResource Brush.TextMuted}"/>
                        <TextBox x:Name="txtPropEncoding" IsReadOnly="True"/>
                    </StackPanel>
                </GroupBox>
            </Border>
        </Grid>

        <!-- Console splitter -->
        <GridSplitter Grid.Row="2"
                      Height="4"
                      Background="{DynamicResource Brush.Border}"
                      ResizeDirection="Rows"
                      HorizontalAlignment="Stretch"
                      Cursor="SizeNS"/>

        <!-- Console panel -->
        <Border Grid.Row="3"
                Background="{DynamicResource Brush.BgSurface}"
                BorderBrush="{DynamicResource Brush.Border}"
                BorderThickness="1"
                MinHeight="100">

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="28"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <DockPanel Background="{DynamicResource Brush.BgApp}">
                    <TextBlock Text="Console"
                               Foreground="{DynamicResource Brush.TextMuted}"
                               VerticalAlignment="Center"
                               Margin="10,0"/>
                </DockPanel>

                <ScrollViewer x:Name="ConsoleScroll" Grid.Row="1">
                    <TextBox x:Name="ConsoleOutput"
                             Background="{DynamicResource Brush.BgApp}"
                             Foreground="{DynamicResource Brush.TextPrimary}"
                             FontFamily="Consolas"
                             FontSize="{DynamicResource EditorFontSize}"
                             BorderThickness="0"
                             IsReadOnly="True"
                             TextWrapping="Wrap"/>
                </ScrollViewer>
            </Grid>
        </Border>

        <Grid Grid.Row="4">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <StatusBar Grid.Column="0"
               Background="{DynamicResource Brush.BgApp}"
               BorderThickness="0">
                <TextBlock x:Name="StatusBarText"
                   Foreground="{DynamicResource Brush.TextMuted}"
                   Text="Ready"/>
            </StatusBar>
            <StackPanel
                Orientation="Horizontal"
                HorizontalAlignment="Center"
                Grid.Column="1" VerticalAlignment="Top">

                <Button Style="{DynamicResource ModernButton}"
                    Content="Deploy Project"
                    Click="DeployProject_Click"/>

                <Button x:Name="RunGameBtn" Style="{DynamicResource PrimaryButton}"
                    Content="{Binding RunGameButtonText}"
                    Margin="12,0,0,0"
                    Click="RunGame_Click" UseLayoutRounding="False"/>
            </StackPanel>
        </Grid>
    </Grid>
</Window>
